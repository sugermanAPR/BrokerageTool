<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New International Sales Order Worksheet</title>
    <style>
        * {
            box-sizing: border-box;
        }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            margin: 0 auto;
        }

        h2 {
            margin: 0 0 10px 0;
            color: #111827;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }

        input,
        select,
        textarea {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #7cb342;
            box-shadow: 0 0 0 3px rgba(124, 179, 66, 0.1);
        }

        .product-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .product-item.inventory-product {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .product-title {
            font-weight: 600;
            color: #111827;
        }

        .product-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: #3b82f6;
            color: white;
            margin-left: 10px;
        }

        .subsection-title {
            font-size: 13px;
            font-weight: 600;
            color: #7cb342;
            margin: 15px 0 10px 0;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 5px;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .add-product-btn {
            background: #7cb342;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .add-product-btn:hover {
            background: #689f38;
        }

        .add-inventory-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .add-inventory-btn:hover {
            background: #2563eb;
        }

        .submit-btn {
            background: #1f2937;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background: #374151;
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .summary {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .summary-total {
            font-weight: 600;
            font-size: 16px;
            border-top: 2px solid #0284c7;
            padding-top: 10px;
            margin-top: 10px;
        }

        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .status-loading {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }

        .status-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .commission-info {
            background: #fef3c7;
            border: 1px solid #fde68a;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
            color: #92400e;
        }

        .inventory-info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
            color: #1e40af;
        }

        /* SO Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 20px auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #111827;
        }

        .close {
            color: #9ca3af;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 30px;
        }

        .so-preview {
            border: 2px solid #e5e7eb;
            padding: 30px;
            background: white;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .so-header {
            text-align: center;
            border-bottom: 3px double #111827;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .so-header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: bold;
        }

        .so-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .so-section {
            margin-bottom: 15px;
        }

        .so-section-title {
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 8px;
        }

        .so-line {
            margin: 4px 0;
        }

        .so-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .so-table th,
        .so-table td {
            border: 1px solid #111827;
            padding: 8px;
            text-align: left;
        }

        .so-table th {
            background: #f3f4f6;
            font-weight: bold;
        }

        .so-table td {
            font-size: 12px;
        }

        .so-total-row {
            font-weight: bold;
            background: #f9fafb;
        }

        .email-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .email-section h3 {
            margin: 0 0 15px 0;
            color: #111827;
            font-size: 16px;
        }

        .email-input-group {
            margin-bottom: 15px;
        }

        .email-input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }

        .email-input-group input,
        .email-input-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .email-input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-primary {
            background: #7cb342;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #689f38;
        }

        .btn-print {
            background: #0284c7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-print:hover {
            background: #0369a1;
        }

        @media print {

            .modal-actions,
            .email-section,
            .close {
                display: none !important;
            }

            .modal-content {
                box-shadow: none;
                border: none;
            }

            .so-preview {
                border: none;
            }
        }
    </style>
</head>

<body>

    <div class="form-container">
        <h2>New International Sales Order Worksheet</h2>
        <p style="color: #6b7280; margin: 0 0 20px 0;">Direct Airtable integration for international shipments. Add
            multiple products with expenses and reps.</p>

        <div id="statusMessage" class="status-message status-loading" style="display: none;">
            üîÑ Loading...
        </div>

        <form id="worksheetForm">
            <!-- TRANSACTION HEADER -->
            <div class="section">
                <div class="section-title">Transaction Info</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Department</label>
                        <select id="department">
            <option value="">Select...</option>
            <option>Shipping</option>
            <option>Accounting</option>
            <option>Logistics</option>
            <option>Admin</option>
            <option>Other</option>
        </select>
                    </div>
                    <div class="form-group">
                        <label>Trade Type</label>
                        <select id="tradeType">
            <option value="">Select...</option>
            <option>Contract</option>
            <option>Spot</option>
            <option>Other</option>
        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Post Date *</label>
                        <input type="date" id="postDate" required>
                    </div>
                    <div class="form-group">
                        <label>Order Date</label>
                        <input type="date" id="orderDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Sales Status</label>
                        <select id="salesStatus" disabled style="background: #f3f4f6; cursor: not-allowed;">
            <option value="">Select...</option>
            <option>WORK</option>
            <option selected>SO Sent</option>
            <option>Invoice Sent</option>
            <option>Approved</option>
            <option>Executed</option>
            <option>Canceled</option>
        </select>
                    </div>
                    <div class="form-group">
                        <label>Purchase Status</label>
                        <select id="purchaseStatus" disabled style="background: #f3f4f6; cursor: not-allowed;">
            <option value="">Select...</option>
            <option selected>WORK</option>
            <option>PO Sent</option>
            <option>Invoice Received</option>
            <option>Approved</option>
            <option>Executed</option>
            <option>Canceled</option>
        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Shipping Status *</label>
                        <select id="logistics" required disabled style="background: #f3f4f6; cursor: not-allowed;">
            <option value="">Select...</option>
            <option selected>WORK</option>
            <option>SCHEDULED</option>
            <option>SHIPPED</option>
            <option>RECIEVED</option>
            <option>CANCELED</option>
        </select>
                    </div>
                    <div class="form-group">
                        <label>Shipping Terms</label>
                        <select id="shippingTerms">
            <option value="">Select...</option>
            <option>FOB</option>
            <option>FAS</option>
            <option>CIF</option>
            <option>CPU</option>
            <option>Delivered</option>
            <option>Other</option>
        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="paymentTerms">
            <option value="">Select...</option>
            <option>Net 10</option>
            <option>Net 15</option>
            <option selected>Net 30</option>
            <option>On Arrival</option>
        </select>
                    </div>
                    <div class="form-group">
                        <label>Domestic or International</label>
                        <select id="domesticInternational" disabled style="background: #f3f4f6; cursor: not-allowed;">
            <option value="">Select...</option>
            <option>Domestic</option>
            <option selected>International</option>
        </select>
                    </div>
                </div>
            </div>

            <!-- SOLD TO -->
            <div class="section">
                <div class="section-title">Bill To / Ship To (Customer)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Customer *</label>
                        <select id="customer" required onchange="updateCustomerAddress()">
                        <option value="">Loading...</option>
                    </select>
                    </div>
                    <div class="form-group">
                        <label>Ship To - Street Address</label>
                        <input type="text" id="shipToStreet" placeholder="123 Main St">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ship To - City</label>
                        <input type="text" id="shipToCity" placeholder="San Francisco">
                    </div>
                    <div class="form-group">
                        <label>Ship To - State</label>
                        <input type="text" id="shipToState" placeholder="CA">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ship To - Zip Code</label>
                        <input type="text" id="shipToZip" placeholder="94102">
                    </div>
                    <div class="form-group">
                        <label>Ship To - Country</label>
                        <input type="text" id="shipToCountry" placeholder="United States">
                    </div>
                </div>
            </div>

            <!-- PRODUCTS -->
            <div class="section">
                <div class="section-title">Products</div>
                <div id="productsContainer"></div>
                <button type="button" class="add-product-btn" id="addProductBtn">‚ûï Add New Product</button>
                <button type="button" class="add-inventory-btn" id="addInventoryBtn">üì¶ Add from Inventory</button>
            </div>

            <!-- SUMMARY -->
            <div class="summary">
                <div class="summary-row">
                    <span>Total Products:</span>
                    <span id="productCount">0</span>
                </div>
                <div class="summary-row">
                    <span>Total Weight:</span>
                    <span id="totalQuantity">0 LBS</span>
                </div>
                <div class="summary-row">
                    <span>Total Revenue:</span>
                    <span id="totalRevenue">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Total Expenses:</span>
                    <span id="totalExpenses">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Total Commission:</span>
                    <span id="totalCommission">$0.00</span>
                </div>
                <div class="summary-row summary-total">
                    <span>Net Profit:</span>
                    <span id="netProfit">$0.00</span>
                </div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">Submit Worksheets to Airtable</button>
        </form>
    </div>

    <!-- SO Modal -->
    <div id="soModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sales Order Preview</h2>
                <span class="close" onclick="closeSOModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="so-preview" id="soPreview">
                    <!-- SO content will be generated here -->
                </div>

                <div class="email-section">
                    <h3>üìß Email Sales Order</h3>
                    <div class="email-input-group">
                        <label>Recipient Email *</label>
                        <input type="email" id="recipientEmail" placeholder="customer@example.com" required>
                    </div>
                    <div class="email-input-group">
                        <label>CC (Optional)</label>
                        <input type="email" id="ccEmail" placeholder="cc@example.com">
                    </div>
                    <div class="email-input-group">
                        <label>Subject</label>
                        <input type="text" id="emailSubject" value="Sales Order from Advanced Polymer Recycling">
                    </div>
                    <div class="email-input-group">
                        <label>Message</label>
                        <textarea id="emailMessage" placeholder="Please find attached our sales order...">Thank you for your order! Please find our sales order attached. 

Delivery is scheduled as indicated on the order. If you have any questions or concerns, please don't hesitate to contact us.

We appreciate your business!</textarea>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeSOModal()">Close</button>
                <button type="button" class="btn-print" onclick="printSO()">üñ®Ô∏è Print SO</button>
                <button type="button" class="btn-primary" onclick="sendSOEmail()">üìß Send Email</button>
            </div>
        </div>
    </div>

    <!-- Load PDF generation libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // AIRTABLE CONFIGURATION
    const AIRTABLE = {
        apiKey: 'patSGxqBvl10GijKc.071943001cbe3c8a6267cc00349270d298608c2487cd0a90bc7ba4ce43069d26',
        baseId: 'appbBATgJDQnniomp',
        tables: {
            worksheets: 'Worksheets',
            companies: 'Companies',
            locations: 'Locations',
            materials: 'MaterialTypes',
            teamMembers: 'Team Members',
            inventory: 'Inventory'
        }
    };
    
    // Data cache
    let companiesData = [];
    let locationsData = [];
    let materialsData = [];
    let teamMembersData = [];
    let inventoryData = [];
    let productCounter = 0;
    let primaryFields = {};
    let currentSOData = null;
    let createdWorksheetIds = [];
    let submittedSONumber = null;
    
    // Initialize
    window.addEventListener('DOMContentLoaded', function() {
        console.log('Form initializing...');
        document.getElementById('postDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
        
        document.getElementById('addProductBtn').addEventListener('click', addProduct);
        document.getElementById('addInventoryBtn').addEventListener('click', addProductFromInventory);
        
        loadData();
    });
    
    // Fetch from Airtable
    async function fetchAirtable(tableName) {
        console.log('Fetching ' + tableName + '...');
        const url = 'https://api.airtable.com/v0/' + AIRTABLE.baseId + '/' + tableName;
        
        const response = await fetch(url, {
            headers: {
                'Authorization': 'Bearer ' + AIRTABLE.apiKey
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Error fetching ' + tableName + ':', errorText);
            throw new Error('Failed to fetch ' + tableName + ': ' + response.status);
        }
        
        const data = await response.json();
        console.log(tableName + ' records:', data.records.length);
        return data.records;
    }
    
    // Load all data
    async function loadData() {
        try {
            showStatus('loading', 'üîÑ Loading data from Airtable...');
            
            companiesData = await fetchAirtable(AIRTABLE.tables.companies);
            primaryFields.company = Object.keys(companiesData[0]?.fields || {})[0];
            
            let companyFields = [];
            for (let i = 0; i < Math.min(5, companiesData.length); i++) {
                const fields = Object.keys(companiesData[i]?.fields || {});
                companyFields = [...new Set([...companyFields, ...fields])];
            }
            
            primaryFields.companyRep = companyFields.find(function(f) {
                return f === 'Rep (Linked)';
            }) || companyFields.find(function(f) {
                return f === 'Rep' || f.toLowerCase().includes('rep');
            });
            
            populateDropdown('customer', companiesData, primaryFields.company);
            
            locationsData = await fetchAirtable(AIRTABLE.tables.locations);
            primaryFields.location = Object.keys(locationsData[0]?.fields || {})[0];
            
            materialsData = await fetchAirtable(AIRTABLE.tables.materials);
            const materialFields = Object.keys(materialsData[0]?.fields || {});
            primaryFields.material = materialFields.find(function(f) {
                return f === 'Product/Grade' || f === 'Product/Grades';
            }) || materialFields[0];
            
            teamMembersData = await fetchAirtable(AIRTABLE.tables.teamMembers);
            const teamFields = Object.keys(teamMembersData[0]?.fields || {});
            primaryFields.teamMember = teamFields.find(function(f) {
                return f === 'Name' || f.toLowerCase().includes('name');
            }) || teamFields[0];
            
            inventoryData = await fetchAirtable(AIRTABLE.tables.inventory);
            const inventoryFields = Object.keys(inventoryData[0]?.fields || {});
            
            primaryFields.inventorySKU = 'Material SKU';
            primaryFields.inventoryPrice = inventoryFields.find(function(f) {
                return f.toLowerCase().includes('price') || f.toLowerCase().includes('cost');
            });
            primaryFields.inventoryWeight = inventoryFields.find(function(f) {
                return f.toLowerCase().includes('weight') || f.toLowerCase().includes('quantity');
            });
            
            primaryFields.inventoryWarehouse = inventoryFields.find(function(f) {
                return f.toLowerCase().includes('warehouse') || 
                       f.toLowerCase().includes('facility') ||
                       f.toLowerCase().includes('location') ||
                       f === 'Warehouse' ||
                       f === 'Facility' ||
                       f === 'Location';
            });
            
            showStatus('success', '‚úÖ Loaded ' + companiesData.length + ' companies, ' + materialsData.length + ' materials');
            setTimeout(function() { hideStatus(); }, 2000);
            
        } catch (error) {
            console.error('Load error:', error);
            showStatus('error', '‚ùå Error: ' + error.message);
        }
    }
    
    // Rest of your functions remain the same but ensure NO arrow functions
    function updateCustomerAddress() {
        const customerSelect = document.getElementById('customer');
        const customerId = customerSelect.value;
        
        if (!customerId) return;
        
        const company = companiesData.find(function(c) { return c.id === customerId; });
        if (!company) return;
        
        const deliveryAddress = company.fields['Delivery Address'] || '';
        const city = company.fields['Location (City)'] || '';
        const state = company.fields['Location (State)'] || '';
        const postalCode = company.fields['Postal Code'] || '';
        
        document.getElementById('shipToStreet').value = deliveryAddress;
        document.getElementById('shipToCity').value = city;
        document.getElementById('shipToState').value = state;
        document.getElementById('shipToZip').value = postalCode;
        
        updateSellRepsFromCustomer();
    }
    
    // Continue with all other functions, converting arrow functions to regular functions...
    
    
    
    
    // Auto-populate supplier address for a specific product
    function updateSupplierAddress(productDiv) {
        const supplierSelect = productDiv.querySelector('[data-field="supplier"]');
        const supplierId = supplierSelect?.value;
        
        if (!supplierId) return;
        
    const company = companiesData.find(function(c) { return c.id === supplierId; });
    if (!company) return;
        
        const deliveryAddress = company.fields['Delivery Address'] || '';
        const city = company.fields['Location (City)'] || '';
        const state = company.fields['Location (State)'] || '';
        const postalCode = company.fields['Postal Code'] || '';
        const country = company.fields['Country'] || 'United States';
        
        productDiv.querySelector('[data-field="pickupStreet"]').value = deliveryAddress;
        productDiv.querySelector('[data-field="pickupCity"]').value = city;
        productDiv.querySelector('[data-field="pickupState"]').value = state;
        productDiv.querySelector('[data-field="pickupZip"]').value = postalCode;
        productDiv.querySelector('[data-field="pickupCountry"]').value = country;
        
        // Update buy rep for this product
        updateBuyRepFromSupplier(productDiv);
    }
    
    
    // Update sell reps from customer
    function updateSellRepsFromCustomer() {
        const customerSelect = document.getElementById('customer');
        const customerId = customerSelect.value;
        
        if (!customerId) return;
        
        const company = companiesData.find(function(c) { return c.id === supplierId; });
        if (!company) return;
        
        const repId = customer.fields[primaryFields.companyRep][0];
        
    const products = document.querySelectorAll('.product-item');
    products.forEach(function(product) {
            const sellRepSelect = product.querySelector('[data-field="sellRep"]');
            if (sellRepSelect && repId) {
                sellRepSelect.value = repId;
                // Don't disable - allow manual changes
                updateProductCalculations(product);
            }
        });
    }
    
    // Update buy rep from supplier for specific product
    function updateBuyRepFromSupplier(productDiv) {
        const supplierSelect = productDiv.querySelector('[data-field="supplier"]');
        const supplierId = supplierSelect?.value;
        
        if (!supplierId) return;
        
    const supplier = companiesData.find(function(c) { return c.id === supplierId; });
    if (!supplier || !supplier.fields[primaryFields.companyRep]) return;
        
        const repId = supplier.fields[primaryFields.companyRep][0];
        const buyRepSelect = productDiv.querySelector('[data-field="buyRep"]');
        
        if (buyRepSelect && repId) {
            buyRepSelect.value = repId;
            // Don't disable - allow manual changes
            updateProductCalculations(productDiv);
        }
    }
    
    // Populate dropdown
    function populateDropdown(fieldId, records, displayField) {
        const select = document.getElementById(fieldId);
        if (!select) return;
        
        select.innerHTML = '<option value="">Select...</option>';
        
        records.forEach(function(record) {
            const option = document.createElement('option');
            option.value = record.id;
            option.textContent = record.fields[displayField] || 'Unnamed';
            option.dataset.name = record.fields[displayField];
            select.appendChild(option);
        });
    }
    
    // Calculate commission with 25% max cap
    function calculateCommission(grossProfit, buyRep, sellRep) {
        if (!grossProfit || grossProfit <= 0) return { buyCommission: 0, sellCommission: 0, total: 0 };
        
        const hasBuyRep = buyRep && buyRep !== '';
        const hasSellRep = sellRep && sellRep !== '';
        
        let buyCommission = 0;
        let sellCommission = 0;
        
        if (hasBuyRep && hasSellRep && buyRep !== sellRep) {
            buyCommission = grossProfit * 0.125;
            sellCommission = grossProfit * 0.125;
        } else if (hasBuyRep || hasSellRep) {
            const commission = grossProfit * 0.25;
            if (hasBuyRep) buyCommission = commission;
            if (hasSellRep) sellCommission = commission;
        }
        
        const total = buyCommission + sellCommission;
        const maxCommission = grossProfit * 0.25;
        
        if (total > maxCommission) {
            const ratio = maxCommission / total;
            buyCommission = buyCommission * ratio;
            sellCommission = sellCommission * ratio;
        }
        
        return {
            buyCommission,
            sellCommission,
            total: buyCommission + sellCommission
        };
    }
    




function loadInventoryItem(selectElement) {
    const productDiv = selectElement.closest('.product-item');
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    
    if (!selectedOption.value) {
        const inventoryInfo = productDiv.querySelector('[data-field="inventoryInfo"]');
        if (inventoryInfo) inventoryInfo.style.display = 'none';
        return;
    }
    
    try {
        const recordData = JSON.parse(selectedOption.dataset.record);
        const recordId = selectedOption.value;
        
        // Auto-fill buy price
        if (primaryFields.inventoryPrice && recordData[primaryFields.inventoryPrice]) {
            const buyPriceInput = productDiv.querySelector('[data-field="buyPrice"]');
            if (buyPriceInput) {
                buyPriceInput.value = recordData[primaryFields.inventoryPrice];
            }
        }
        
        const availableWeight = recordData[primaryFields.inventoryWeight] || 0;
        
        let warehouseName = 'Unknown Warehouse';
        let warehouseRecordId = null;
        
        if (recordData[primaryFields.inventoryWarehouse]) {
            const warehouseData = recordData[primaryFields.inventoryWarehouse];
            
            if (Array.isArray(warehouseData)) {
                warehouseRecordId = warehouseData[0];
            } else if (typeof warehouseData === 'string') {
                warehouseRecordId = warehouseData;
            }
            
            
  // Rest of the warehouse logic...
            if (warehouseRecordId && warehouseRecordId.indexOf('rec') === 0) {
                const location = locationsData.find(function(loc) { return loc.id === warehouseRecordId; });
                if (location) {
                    warehouseName = location.fields[primaryFields.location] || warehouseRecordId;
                    
                if (location) {
                    console.log('Location primary field name:', primaryFields.location);
                    console.log('Location fields:', location.fields);
                    warehouseName = location.fields[primaryFields.location] || warehouseRecordId;
                    
                    // Populate pickup address from warehouse
                    if (location.fields['Street Address']) {
                        productDiv.querySelector('[data-field="pickupStreet"]').value = location.fields['Street Address'];
                    }
                    if (location.fields['City']) {
                        productDiv.querySelector('[data-field="pickupCity"]').value = location.fields['City'];
                    }
                    if (location.fields['State']) {
                        productDiv.querySelector('[data-field="pickupState"]').value = location.fields['State'];
                    }
                    if (location.fields['Zip Code']) {
                        productDiv.querySelector('[data-field="pickupZip"]').value = location.fields['Zip Code'];
                    }
                    // Set default country since it's not in Locations table
                    productDiv.querySelector('[data-field="pickupCountry"]').value = 'United States';

                    // NOW set the warehouse display and supplier - after we know location exists
                    const warehouseDisplay = productDiv.querySelector('[data-field="warehouseDisplay"]');
                    if (warehouseDisplay) {
                        warehouseDisplay.value = warehouseName;
                    }
                    
                    // Store the supplier ID from Site Name
                    const supplierHidden = productDiv.querySelector('[data-field="supplier"]');
                    if (supplierHidden && location.fields['Site Name']) {
                        const siteNameData = location.fields['Site Name'];
                        if (Array.isArray(siteNameData) && siteNameData.length > 0) {
                            supplierHidden.value = siteNameData[0];
                        }
                    }
                } else {
                    warehouseName = warehouseRecordId;
                }
            } else {
                warehouseName = warehouseRecordId;
            }
        }
        
        console.log('Raw warehouse name:', warehouseName);
        console.log('Warehouse record ID:', warehouseRecordId);

        // Clean warehouse name (remove only emojis)
        warehouseName = warehouseName.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
        warehouseName = warehouseName.replace(/[^\w\s-]/g, '');
        warehouseName = warehouseName.trim();
        
        const inventoryInfo = productDiv.querySelector('[data-field="inventoryInfo"]');
        if (inventoryInfo) {
            inventoryInfo.textContent = `üì¶ Available: ${availableWeight.toLocaleString()} LBS at ${warehouseName}`;
            inventoryInfo.style.display = 'block';
        }
        
        productDiv.dataset.inventoryRecordId = recordId;
        productDiv.dataset.availableWeight = availableWeight;
        productDiv.dataset.warehouseName = warehouseName;
        productDiv.dataset.warehouseRecordId = warehouseRecordId || '';
        
        const materialField = Object.keys(recordData).find(function(f) {
            return f.toLowerCase().includes('product') || 
                   f.toLowerCase().includes('material') ||
                   f.toLowerCase().includes('type');
        });
        
        if (materialField && recordData[materialField]) {
            productDiv.dataset.linkedMaterial = JSON.stringify(recordData[materialField]);
        }
        
        updateProductCalculations(productDiv);
        
    } catch (error) {
        console.error('Error loading inventory item:', error);
        const inventoryInfo = productDiv.querySelector('[data-field="inventoryInfo"]');
        if (inventoryInfo) {
            inventoryInfo.textContent = '‚ö†Ô∏è Error loading inventory details';
            inventoryInfo.style.display = 'block';
        }
    }
}
    
    
    
    
    
   // Add product from inventory
function addProductFromInventory() {
    productCounter++;
    const container = document.getElementById('productsContainer');
    
    const productDiv = document.createElement('div');
    productDiv.className = 'product-item inventory-product';
    productDiv.id = `product-${productCounter}`;
    productDiv.dataset.isInventory = 'true';
    
    productDiv.innerHTML = `
        <div class="product-header">
            <div>
                <span class="product-title">Product ${productCounter}</span>
                <span class="product-badge">FROM INVENTORY</span>
            </div>
            <button type="button" class="remove-btn" data-product-id="${productCounter}">Remove</button>
        </div>
        
        <div class="subsection-title">Select from Inventory</div>
        <div class="form-row">
            <div class="form-group">
                <label>Material SKU *</label>
                <select class="product-field" data-field="inventoryItem" required onchange="loadInventoryItem(this)">
                    <option value="">Select by Material SKU...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Weight (LBS) *</label>
                <input type="number" class="product-field" data-field="weight" required onchange="validateInventoryWeight(this)">
            </div>
        </div>
        <div class="inventory-info" data-field="inventoryInfo" style="display: none;"></div>
        
<div class="subsection-title">Sourced From (Internal Use - Not Shown on SO)</div>
<div class="form-row">
    <div class="form-group">
        <label>Warehouse</label>
        <input type="text" class="product-field" data-field="warehouseDisplay" readonly style="background: #f3f4f6;">
        <input type="hidden" class="product-field" data-field="supplier">
    </div>
    <div class="form-group">
        <label>Pickup - Street Address</label>
        <input type="text" class="product-field" data-field="pickupStreet" placeholder="456 Oak Ave" readonly style="background: #f3f4f6;">
    </div>
</div>
        <div class="form-row">
            <div class="form-group">
                <label>Pickup - City</label>
                <input type="text" class="product-field" data-field="pickupCity" placeholder="Los Angeles" readonly style="background: #f3f4f6;">
            </div>
            <div class="form-group">
                <label>Pickup - State</label>
                <input type="text" class="product-field" data-field="pickupState" placeholder="CA" readonly style="background: #f3f4f6;">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Pickup - Zip Code</label>
                <input type="text" class="product-field" data-field="pickupZip" placeholder="90001" readonly style="background: #f3f4f6;">
            </div>
            <div class="form-group">
                <label>Pickup - Country</label>
                <input type="text" class="product-field" data-field="pickupCountry" placeholder="United States" readonly style="background: #f3f4f6;">
            </div>
        </div>

        <div class="subsection-title">Loading Port</div>
        <div class="form-row">
            <div class="form-group">
                <label>Loading Port</label>
                <input type="text" class="product-field" data-field="loadingPort" placeholder="e.g., Port of Los Angeles">
            </div>
            <div class="form-group"></div>
        </div>
        
        <div class="subsection-title">Pricing (Auto-filled from Inventory)</div>
        <div class="form-row">
            <div class="form-group">
                <label>Buy Price (per LB) *</label>
                <input type="number" step="0.01" class="product-field" data-field="buyPrice" required readonly style="background: #f3f4f6;">
            </div>
            <div class="form-group">
                <label>Sell Price (per LB)</label>
                <input type="number" step="0.01" class="product-field" data-field="sellPrice">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Gross Profit</label>
                <input type="text" class="product-field" data-field="grossProfit" readonly style="background: #f3f4f6;">
            </div>
            <div class="form-group"></div>
        </div>
        
        <div class="subsection-title">Expenses</div>
        <div class="form-row">
            <div class="form-group">
                <label>Carrier</label>
                <select class="product-field" data-field="logisticsCompany">
                    <option value="">Select...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Freight Cost</label>
                <input type="number" step="0.01" class="product-field" data-field="freightCost" value="0">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Ocean Freight</label>
                <input type="number" step="0.01" class="product-field" data-field="oceanFreight" value="0">
            </div>
            <div class="form-group">
                <label>Deposit</label>
                <input type="number" step="0.01" class="product-field" data-field="deposit" value="0">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Tariff</label>
                <input type="number" step="0.01" class="product-field" data-field="tariff" value="0">
            </div>
            <div class="form-group">
                <label>Import Cost</label>
                <input type="number" step="0.01" class="product-field" data-field="importCost" value="0">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Other (Explain)</label>
                <input type="text" class="product-field" data-field="otherExpense1">
            </div>
            <div class="form-group">
                <label>Other Cost</label>
                <input type="number" step="0.01" class="product-field" data-field="otherExpense1Cost" value="0">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Other (Explain) 2</label>
                <input type="text" class="product-field" data-field="otherExpense2">
            </div>
            <div class="form-group">
                <label>Other Cost 2</label>
                <input type="number" step="0.01" class="product-field" data-field="otherExpense2Cost" value="0">
            </div>
        </div>
        
        <div class="subsection-title">Shipping References</div>
        <div class="form-row">
            <div class="form-group">
                <label>Schd Pick Up Date</label>
                <input type="date" class="product-field" data-field="schdPickUpDate">
            </div>
            <div class="form-group">
                <label>Container #</label>
                <input type="text" class="product-field" data-field="containerNo">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Booking No</label>
                <input type="number" class="product-field" data-field="bookingNo">
            </div>
            <div class="form-group">
                <label>Release No</label>
                <input type="number" class="product-field" data-field="releaseNo">
            </div>
        </div>
        
        <div class="subsection-title">Team & Commission</div>
        <div class="form-row">
            <div class="form-group">
                <label>Buy Rep</label>
                <select class="product-field" data-field="buyRep">
                    <option value="">None</option>
                </select>
            </div>
            <div class="form-group">
                <label>Sell Rep</label>
                <select class="product-field" data-field="sellRep">
                    <option value="">None</option>
                </select>
            </div>
        </div>
        <div class="commission-info" data-field="commissionInfo" style="display: none;"></div>
    `;
    
    container.appendChild(productDiv);
    
    const inventorySelect = productDiv.querySelector('[data-field="inventoryItem"]');
    inventoryData.filter(function(record) { 
        return record.fields['Status'] !== 'Sold'; 
    }).forEach(function(record) {
        const option = document.createElement('option');
        option.value = record.id;
        const skuText = record.fields[primaryFields.inventorySKU];
        option.textContent = skuText || 'Unnamed Item';
        option.dataset.record = JSON.stringify(record.fields);
        inventorySelect.appendChild(option);
    });
    
    // Populate supplier dropdown for inventory items
    const supplierSelect = productDiv.querySelector('[data-field="supplier"]');
    companiesData.forEach(function(record) {
        const option = document.createElement('option');
        option.value = record.id;
        option.textContent = record.fields[primaryFields.company];
        option.dataset.name = record.fields[primaryFields.company];
        supplierSelect.appendChild(option);
    });
    
    // Populate logistics company dropdown
    const logisticsSelect = productDiv.querySelector('[data-field="logisticsCompany"]');
    companiesData.forEach(function(record) {
        const option = document.createElement('option');
        option.value = record.id;
        option.textContent = record.fields[primaryFields.company];
        option.dataset.name = record.fields[primaryFields.company];
        logisticsSelect.appendChild(option);
    });
    
    // Populate team members dropdowns
    const buyRepSelect = productDiv.querySelector('[data-field="buyRep"]');
    const sellRepSelect = productDiv.querySelector('[data-field="sellRep"]');
    
    teamMembersData.forEach(function(record) {
        const name = record.fields[primaryFields.teamMember];
        
        const buyOption = document.createElement('option');
        buyOption.value = record.id;
        buyOption.textContent = name;
        buyOption.dataset.name = name;
        buyRepSelect.appendChild(buyOption);
        
        const sellOption = document.createElement('option');
        sellOption.value = record.id;
        sellOption.textContent = name;
        sellOption.dataset.name = name;
        sellRepSelect.appendChild(sellOption);
    });
    
    // Add change listeners
    const inputs = productDiv.querySelectorAll('input[type="number"], select');
inputs.forEach(function(input) {
    input.addEventListener('input', function() { 
        updateProductCalculations(productDiv);
    });
    });


     // Add remove button listener
productDiv.querySelector('.remove-btn').addEventListener('click', function() {
    const productId = this.dataset.productId;
    removeProduct(productId);
});
    updateSellRepsFromCustomer();
    updateSummary();
}
    
    // Validate inventory weight doesn't exceed available
    function validateInventoryWeight(input) {
        const productDiv = input.closest('.product-item');
        const availableWeight = parseFloat(productDiv.dataset.availableWeight || 0);
        const requestedWeight = parseFloat(input.value || 0);
        
        if (requestedWeight > availableWeight) {
            alert(`‚ö†Ô∏è Requested weight (${requestedWeight} LBS) exceeds available inventory (${availableWeight} LBS)`);
            input.value = availableWeight;
        }
        
        updateProductCalculations(productDiv);
    }
    
    // Add product (regular)
    function addProduct() {
        productCounter++;
        const container = document.getElementById('productsContainer');
        
        const productDiv = document.createElement('div');
        productDiv.className = 'product-item';
        productDiv.id = `product-${productCounter}`;
        
        productDiv.innerHTML = `
            <div class="product-header">
                <div class="product-title">Product ${productCounter}</div>
                <button type="button" class="remove-btn" data-product-id="${productCounter}">Remove</button>
            </div>
            
            <div class="subsection-title">Product Details</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Material *</label>
                    <select class="product-field" data-field="material" required>
                        <option value="">Select...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Weight (LBS) *</label>
                    <input type="number" class="product-field" data-field="weight" required>
                </div>
            </div>
            
            <div class="subsection-title">Sourced From (Internal Use - Not Shown on SO)</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Supplier *</label>
                    <select class="product-field" data-field="supplier" required onchange="updateSupplierAddress(this.closest('.product-item'))">
                        <option value="">Select...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pickup - Street Address</label>
                    <input type="text" class="product-field" data-field="pickupStreet" placeholder="456 Oak Ave">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Pickup - City</label>
                    <input type="text" class="product-field" data-field="pickupCity" placeholder="Los Angeles">
                </div>
                <div class="form-group">
                    <label>Pickup - State</label>
                    <input type="text" class="product-field" data-field="pickupState" placeholder="CA">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Pickup - Zip Code</label>
                    <input type="text" class="product-field" data-field="pickupZip" placeholder="90001">
                </div>
                <div class="form-group">
                    <label>Pickup - Country</label>
                    <input type="text" class="product-field" data-field="pickupCountry" placeholder="United States">
                </div>
            </div>

            <div class="subsection-title">Loading Port</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Loading Port</label>
                    <input type="text" class="product-field" data-field="loadingPort" placeholder="e.g., Port of Los Angeles">
                </div>
                <div class="form-group"></div>
            </div>
            
            <div class="subsection-title">Pricing</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Buy Price (per LB) *</label>
                    <input type="number" step="0.01" class="product-field" data-field="buyPrice" required>
                </div>
                <div class="form-group">
                    <label>Sell Price (per LB)</label>
                    <input type="number" step="0.01" class="product-field" data-field="sellPrice">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Gross Profit</label>
                    <input type="text" class="product-field" data-field="grossProfit" readonly style="background: #f3f4f6;">
                </div>
                <div class="form-group"></div>
            </div>
            
            <div class="subsection-title">Expenses</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Carrier</label>
                    <select class="product-field" data-field="logisticsCompany">
                        <option value="">Select...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Freight Cost</label>
                    <input type="number" step="0.01" class="product-field" data-field="freightCost" value="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Ocean Freight</label>
                    <input type="number" step="0.01" class="product-field" data-field="oceanFreight" value="0">
                </div>
                <div class="form-group">
                    <label>Deposit</label>
                    <input type="number" step="0.01" class="product-field" data-field="deposit" value="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Tariff</label>
                    <input type="number" step="0.01" class="product-field" data-field="tariff" value="0">
                </div>
                <div class="form-group">
                    <label>Import Cost</label>
                    <input type="number" step="0.01" class="product-field" data-field="importCost" value="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Other (Explain)</label>
                    <input type="text" class="product-field" data-field="otherExpense1">
                </div>
                <div class="form-group">
                    <label>Other Cost</label>
                    <input type="number" step="0.01" class="product-field" data-field="otherExpense1Cost" value="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Other (Explain) 2</label>
                    <input type="text" class="product-field" data-field="otherExpense2">
                </div>
                <div class="form-group">
                    <label>Other Cost 2</label>
                    <input type="number" step="0.01" class="product-field" data-field="otherExpense2Cost" value="0">
                </div>
            </div>
            
            <div class="subsection-title">Shipping References</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Schd Pick Up Date</label>
                    <input type="date" class="product-field" data-field="schdPickUpDate">
                </div>
                <div class="form-group">
                    <label>Container #</label>
                    <input type="text" class="product-field" data-field="containerNo">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Booking No</label>
                    <input type="number" class="product-field" data-field="bookingNo">
                </div>
                <div class="form-group">
                    <label>Release No</label>
                    <input type="number" class="product-field" data-field="releaseNo">
                </div>
            </div>
            
            <div class="subsection-title">Team & Commission</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Buy Rep</label>
                    <select class="product-field" data-field="buyRep">
                        <option value="">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sell Rep</label>
                    <select class="product-field" data-field="sellRep">
                        <option value="">None</option>
                    </select>
                </div>
            </div>
            <div class="commission-info" data-field="commissionInfo" style="display: none;"></div>
        `;
        
        container.appendChild(productDiv);
        
        // Populate materials dropdown
        const materialSelect = productDiv.querySelector('[data-field="material"]');
        materialsData.forEach(function(record) {
            const option = document.createElement('option');
            option.value = record.id;
            option.textContent = record.fields[primaryFields.material];
            option.dataset.name = record.fields[primaryFields.material];
            materialSelect.appendChild(option);
        });
        
        // Populate supplier dropdown
        const supplierSelect = productDiv.querySelector('[data-field="supplier"]');
companiesData.forEach(function(record) {
            const option = document.createElement('option');
            option.value = record.id;
            option.textContent = record.fields[primaryFields.company];
            option.dataset.name = record.fields[primaryFields.company];
            supplierSelect.appendChild(option);
        });
        
        // Populate logistics company dropdown
        const logisticsSelect = productDiv.querySelector('[data-field="logisticsCompany"]');
companiesData.forEach(function(record) {
            const option = document.createElement('option');
            option.value = record.id;
            option.textContent = record.fields[primaryFields.company];
            option.dataset.name = record.fields[primaryFields.company];
            logisticsSelect.appendChild(option);
        });
        
        // Populate team members dropdowns
        const buyRepSelect = productDiv.querySelector('[data-field="buyRep"]');
        const sellRepSelect = productDiv.querySelector('[data-field="sellRep"]');
        
    teamMembersData.forEach(function(record) {
            const name = record.fields[primaryFields.teamMember];
            
            const buyOption = document.createElement('option');
            buyOption.value = record.id;
            buyOption.textContent = name;
            buyOption.dataset.name = name;
            buyRepSelect.appendChild(buyOption);
            
            const sellOption = document.createElement('option');
            sellOption.value = record.id;
            sellOption.textContent = name;
            sellOption.dataset.name = name;
            sellRepSelect.appendChild(sellOption);
        });
        
        // Add change listeners
        const inputs = productDiv.querySelectorAll('input[type="number"], select');
inputs.forEach(function(input) {
                input.addEventListener('input', function() { 
        updateProductCalculations(productDiv);
        });
        });


        
        // Auto-fill sell rep from customer
        updateSellRepsFromCustomer();
        
        // Add remove button listener
productDiv.querySelector('.remove-btn').addEventListener('click', function() {
    const productId = this.dataset.productId;
    removeProduct(productId);
});
        updateProductCalculations(productDiv);
        updateSummary();
    }
    
    function updateProductCalculations(productDiv) {
        const weight = parseFloat(productDiv.querySelector('[data-field="weight"]')?.value || 0);
        const buyPrice = parseFloat(productDiv.querySelector('[data-field="buyPrice"]')?.value || 0);
        const sellPrice = parseFloat(productDiv.querySelector('[data-field="sellPrice"]')?.value || 0);
        const freightCost = parseFloat(productDiv.querySelector('[data-field="freightCost"]')?.value || 0);
        const oceanFreight = parseFloat(productDiv.querySelector('[data-field="oceanFreight"]')?.value || 0);
        const deposit = parseFloat(productDiv.querySelector('[data-field="deposit"]')?.value || 0);
        const tariff = parseFloat(productDiv.querySelector('[data-field="tariff"]')?.value || 0);
        const importCost = parseFloat(productDiv.querySelector('[data-field="importCost"]')?.value || 0);
        const otherExpense1Cost = parseFloat(productDiv.querySelector('[data-field="otherExpense1Cost"]')?.value || 0);
        const otherExpense2Cost = parseFloat(productDiv.querySelector('[data-field="otherExpense2Cost"]')?.value || 0);
        
        const revenue = sellPrice * weight;
        const cost = buyPrice * weight;
        const totalExpenses = freightCost + oceanFreight + deposit + tariff + importCost + otherExpense1Cost + otherExpense2Cost;
        const grossProfit = revenue - cost - totalExpenses;
        
        const profitField = productDiv.querySelector('[data-field="grossProfit"]');
        if (grossProfit !== 0) {
            profitField.value = '$' + grossProfit.toLocaleString('en-US', {minimumFractionDigits: 2});
        } else {
            profitField.value = '';
        }
        
        const buyRepSelect = productDiv.querySelector('[data-field="buyRep"]');
        const sellRepSelect = productDiv.querySelector('[data-field="sellRep"]');
        const buyRepName = buyRepSelect.options[buyRepSelect.selectedIndex]?.dataset.name || '';
        const sellRepName = sellRepSelect.options[sellRepSelect.selectedIndex]?.dataset.name || '';
        
        const commission = calculateCommission(grossProfit, buyRepSelect.value, sellRepSelect.value);
        
        const commissionInfo = productDiv.querySelector('[data-field="commissionInfo"]');
        if (commission.total > 0) {
            let info = 'üí∞ Commission: ';
            if (commission.buyCommission > 0) {
                info += `${buyRepName}: $${commission.buyCommission.toFixed(2)}`;
            }
            if (commission.sellCommission > 0) {
                if (commission.buyCommission > 0) info += ' | ';
                info += `${sellRepName}: $${commission.sellCommission.toFixed(2)}`;
            }
            info += ` (Total: $${commission.total.toFixed(2)})`;
            commissionInfo.textContent = info;
            commissionInfo.style.display = 'block';
        } else {
            commissionInfo.style.display = 'none';
        }
        
        updateSummary();
    }
    
    function removeProduct(id) {
        document.getElementById(`product-${id}`).remove();
        updateSummary();
    }
    
    function updateSummary() {
        const products = document.querySelectorAll('.product-item');
        let totalWeight = 0;
        let totalRevenue = 0;
        let totalExpenses = 0;
        let totalCommission = 0;
        
    products.forEach(function(product) {
            const weight = parseFloat(product.querySelector('[data-field="weight"]')?.value || 0);
            const buyPrice = parseFloat(product.querySelector('[data-field="buyPrice"]')?.value || 0);
            const sellPrice = parseFloat(product.querySelector('[data-field="sellPrice"]')?.value || 0);
            const freightCost = parseFloat(product.querySelector('[data-field="freightCost"]')?.value || 0);
            const oceanFreight = parseFloat(product.querySelector('[data-field="oceanFreight"]')?.value || 0);
            const deposit = parseFloat(product.querySelector('[data-field="deposit"]')?.value || 0);
            const tariff = parseFloat(product.querySelector('[data-field="tariff"]')?.value || 0);
            const importCost = parseFloat(product.querySelector('[data-field="importCost"]')?.value || 0);
            const otherExpense1Cost = parseFloat(product.querySelector('[data-field="otherExpense1Cost"]')?.value || 0);
            const otherExpense2Cost = parseFloat(product.querySelector('[data-field="otherExpense2Cost"]')?.value || 0);
            
            totalWeight += weight;
            totalRevenue += sellPrice * weight;
            totalExpenses += (buyPrice * weight) + freightCost + oceanFreight + deposit + tariff + importCost + otherExpense1Cost + otherExpense2Cost;
            
            const productExpenses = freightCost + oceanFreight + deposit + tariff + importCost + otherExpense1Cost + otherExpense2Cost;
            const grossProfit = (sellPrice * weight) - (buyPrice * weight) - productExpenses;
            const buyRep = product.querySelector('[data-field="buyRep"]')?.value;
            const sellRep = product.querySelector('[data-field="sellRep"]')?.value;
            const commission = calculateCommission(grossProfit, buyRep, sellRep);
            totalCommission += commission.total;
        });
        
        const netProfit = totalRevenue - totalExpenses - totalCommission;
        
        document.getElementById('productCount').textContent = products.length;
        document.getElementById('totalQuantity').textContent = totalWeight.toLocaleString() + ' LBS';
        document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('totalExpenses').textContent = '$' + totalExpenses.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('totalCommission').textContent = '$' + totalCommission.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('netProfit').textContent = '$' + netProfit.toLocaleString('en-US', {minimumFractionDigits: 2});
    }
    
    function showStatus(type, message) {
        const el = document.getElementById('statusMessage');
        el.className = `status-message status-${type}`;
        el.textContent = message;
        el.style.display = 'block';
    }
    
    function hideStatus() {
        document.getElementById('statusMessage').style.display = 'none';
    }

    // SO Modal Functions
    function generateSONumber(loadNumber = null) {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const random = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
        const baseNumber = `SO-${year}${month}${day}-${random}`;
        
        if (loadNumber !== null && loadNumber > 0) {
            return `${baseNumber}-${loadNumber}`;
        }
        return baseNumber;
    }

    function generateWorksheetNumber() {
        const min = 10000;
        const max = 99999;
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateSOPreview() {
    const soNumber = submittedSONumber || generateSONumber();
    const today = new Date().toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
    });
    
    const customerSelect = document.getElementById('customer');
    const customerName = customerSelect.options[customerSelect.selectedIndex]?.dataset.name || 'Customer';
    
    const shipToStreet = document.getElementById('shipToStreet').value || '';
    const shipToCity = document.getElementById('shipToCity').value || '';
    const shipToState = document.getElementById('shipToState').value || '';
    const shipToZip = document.getElementById('shipToZip').value || '';
    const shipToAddress = [shipToStreet, `${shipToCity}, ${shipToState} ${shipToZip}`]
    .filter(s => s.trim())
    .join('\n');
    
    const paymentTerms = document.getElementById('paymentTerms').value || 'Net 30';
    const shippingTerms = document.getElementById('shippingTerms').value || '';
    const orderDateValue = document.getElementById('orderDate').value;
    const schdPickUpDate = orderDateValue ? new Date(orderDateValue).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
    }) : today;
    
    const lastUpdated = new Date().toLocaleString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
    });
    
    let totalWeight = 0;
    let totalAmount = 0;
    
    const products = document.querySelectorAll('.product-item');
    const productRows = Array.from(products).map(function(product) {
    const isInventory = product.dataset.isInventory === 'true';
    let materialName = 'Material';
    const directFromSupplier = isInventory ? 'No' : 'Yes';
    
    if (isInventory) {
    const inventorySelect = product.querySelector('[data-field="inventoryItem"]');
    materialName = inventorySelect.options[inventorySelect.selectedIndex]?.textContent || 'Inventory Item';
    } else {
    const materialSelect = product.querySelector('[data-field="material"]');
    materialName = materialSelect.options[materialSelect.selectedIndex]?.textContent || 'Material';
    }
    
    const weight = parseFloat(product.querySelector('[data-field="weight"]')?.value || 0);
    const sellPrice = parseFloat(product.querySelector('[data-field="sellPrice"]')?.value || 0);
    const amount = weight * sellPrice;
    
    totalWeight += weight;
    totalAmount += amount;
    
    return {
    material: materialName,
    directFromSupplier: directFromSupplier,
    weight: weight,
    price: sellPrice,
    amount: amount
    };
    });
    
    const html = `
    <div class="so-header">
        <h1>SALES ORDER</h1>
        <div style="font-size: 14px; margin-top: 10px;">
            <strong>Advanced Polymer Recycling</strong><br>
                    123 Business Park Dr<br>
                    Recycling City, CA 12345<br>
                    Phone: (555) 123-4567 | Email: sales@apr.com
        </div>
    </div>
    
    <div class="so-info-grid">
        <div>
            <div class="so-section">
                <div class="so-section-title">Order Information</div>
                <div class="so-line"><strong>SO Number:</strong> ${soNumber}</div>
                <div class="so-line"><strong>Order Date:</strong> ${today}</div>
                <div class="so-line"><strong>Scheduled Pick Up Date:</strong> ${schdPickUpDate}</div>
                <div class="so-line"><strong>Payment Terms:</strong> ${paymentTerms}</div>
                ${shippingTerms ? `<div class="so-line"><strong>Shipping Terms:</strong> ${shippingTerms}</div>` : ''}
                <div class="so-line"><strong>Last Updated:</strong> ${lastUpdated}</div>
            </div>
        </div>
    
        <div>
            <div class="so-section">
                <div class="so-section-title">Bill To / Ship To</div>
                <div class="so-line"><strong>${customerName}</strong></div>
                <div class="so-line">${shipToAddress || 'Address not provided'}</div>
            </div>
        </div>
    </div>
    
    <table class="so-table">
        <thead>
            <tr>
                <th>Item</th>
                <th>Material/Product</th>
                <th>Direct from Supplier</th>
                <th>Quantity (LBS)</th>
                <th>Price per LB</th>
                <th>Amount</th>
            </tr>
        </thead>
      <tbody>
            ${productRows.map(function(row, idx) {
                return `
            <tr>
                <td>${idx + 1}</td>
                <td>${row.material}</td>
                <td>${row.directFromSupplier}</td>
                <td>${row.weight.toLocaleString()}</td>
                <td>$${row.price.toFixed(2)}</td>
                <td>$${row.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            </tr>
            `;
            }).join('')}

            <tr class="so-total-row">
                <td colspan="3"><strong>TOTAL</strong></td>
                <td><strong>${totalWeight.toLocaleString()} LBS</strong></td>
                <td></td>
                <td><strong>$${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
            </tr>
        </tbody>
    </table>
    
    <div class="so-section">
        <div class="so-section-title">Terms & Conditions</div>
        <div class="so-line">‚Ä¢ Payment due per terms: ${paymentTerms}</div>
        ${shippingTerms ? `<div class="so-line">‚Ä¢ Shipping terms: ${shippingTerms}</div>` : ''}
        <div class="so-line">‚Ä¢ Material subject to inspection upon delivery</div>
        <div class="so-line">‚Ä¢ Shipping arranged as specified in order</div>
        <div class="so-line">‚Ä¢ Material meets specified quality standards</div>
        <div class="so-line">‚Ä¢ For questions, please reference SO number ${soNumber}</div>
    </div>
    
    <div style="margin-top: 30px; border-top: 2px solid #111827; padding-top: 15px; text-align: center; font-size: 12px;">
        Thank you for your business!<br>
                Advanced Polymer Recycling - Your Trusted Partner in Sustainable Recycling
    </div>
    `;
    
    currentSOData = {
    soNumber,
    customerName,
    html,
    totalAmount
    };
    
    return html;
    }

    function showSOModal() {
        const soPreview = document.getElementById('soPreview');
        soPreview.innerHTML = generateSOPreview();
        
        // Get customer email for pre-fill
        const customerSelect = document.getElementById('customer');
        const customerId = customerSelect.value;
        
        if (customerId) {
        const customer = companiesData.find(function(c) { return c.id === customerId; });
        if (customer) {
                const primaryEmail = customer.fields['Email'] || '';
                const secondaryEmail = customer.fields['Email (2nd)'] || '';
                
                if (primaryEmail) {
                    document.getElementById('recipientEmail').value = primaryEmail;
                }
                if (secondaryEmail) {
                    document.getElementById('ccEmail').value = secondaryEmail;
                }
            }
        }
        
        document.getElementById('soModal').style.display = 'block';
    }

    function closeSOModal() {
        document.getElementById('soModal').style.display = 'none';
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Worksheets to Airtable';
        window.location.href = '/';
    }

    function printSO() {
        window.print();
        setTimeout(function() {
            window.location.href = '/';
        }, 1000);
    }

    async function generateAndUploadSO() {
        try {
            showStatus('loading', 'üìÑ Generating SO PDF...');
            
            const { jsPDF } = window.jspdf;
            const soPreview = document.getElementById('soPreview');
            
            const canvas = await html2canvas(soPreview, {
                scale: 2,
                logging: false,
                useCORS: true
            });
            
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            
            const pdfBlob = pdf.output('blob');
            
            const reader = new FileReader();
            reader.readAsDataURL(pdfBlob);
            
            return new Promise((resolve, reject) => {
                reader.onloadend = async function() {
                    try {
                        const base64data = reader.result;
                        
                        showStatus('loading', 'üì§ Uploading SO to Airtable...');
                        
                        for (const recordId of createdWorksheetIds) {
                            const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE.baseId}/${AIRTABLE.tables.worksheets}/${recordId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Authorization': `Bearer ${AIRTABLE.apiKey}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    fields: {
                                        'SO Attachment': [
                                            {
                                                url: base64data,
                                                filename: `${currentSOData.soNumber}.pdf`
                                            }
                                        ]
                                    }
                                })
                            });
                            
                            if (!response.ok) {
                                const error = await response.json();
                                console.error('Upload error:', error);
                                throw new Error('Failed to upload SO');
                            }
                        }
                        
                        showStatus('success', '‚úÖ SO saved to Airtable!');
                        setTimeout(function() { hideStatus(); }, 2000);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
            });
        } catch (error) {
            console.error('PDF generation error:', error);
            showStatus('error', '‚ùå Error generating PDF: ' + error.message);
            throw error;
        }
    }

    async function sendSOEmail() {
        const recipientEmail = document.getElementById('recipientEmail').value;
        const ccEmail = document.getElementById('ccEmail').value;
        const subject = document.getElementById('emailSubject').value;
        const message = document.getElementById('emailMessage').value;
        
        if (!recipientEmail) {
            alert('Please enter a recipient email address');
            return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(recipientEmail)) {
            alert('Please enter a valid email address');
            return;
        }
        
        if (ccEmail && !emailRegex.test(ccEmail)) {
            alert('Please enter a valid CC email address');
            return;
        }
        
        showStatus('loading', 'üìß Preparing SO email...');
        
        try {
            const emailBody = `${message}\n\n---\nSales Order Details:\nSO Number: ${currentSOData.soNumber}\nCustomer: ${currentSOData.customerName}\nTotal Amount: $${currentSOData.totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}\n\nPlease see the attached sales order for complete details.`;
            
            const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}${ccEmail ? `&cc=${ccEmail}` : ''}`;
            
            window.location.href = mailtoLink;
            
            showStatus('success', '‚úÖ Email client opened! Please send the email from your email application.');
            
            setTimeout(function() {
                hideStatus();
                closeSOModal();
                window.location.href = '/';
            }, 2000);
            
        } catch (error) {
            console.error('Email error:', error);
            showStatus('error', '‚ùå Error preparing email. Please try again.');
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('soModal');
        if (event.target == modal) {
            closeSOModal();
        }
    }
    
    // Form submission
    document.getElementById('worksheetForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        showStatus('loading', '‚è≥ Creating worksheets in Airtable...');
        
        try {
            const products = document.querySelectorAll('.product-item');
            const baseSONumber = `SO-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`;
            
            const shouldAddLoadNumbers = products.length > 1;
            
            createdWorksheetIds = [];
            
            let loadCounter = 0;
            for (const product of products) {
                loadCounter++;
                
                const soNumber = shouldAddLoadNumbers ? `${baseSONumber}-${loadCounter}` : baseSONumber;
                
                if (loadCounter === 1) {
                    submittedSONumber = baseSONumber;
                }
                
                const isInventory = product.dataset.isInventory === 'true';
                const directFromSupplier = isInventory ? 'No' : 'Yes';
                
                let materialId = null;
                let materialSKU = null;
                let inventoryRecordId = null;
                
                if (isInventory) {
                    const inventorySelect = product.querySelector('[data-field="inventoryItem"]');
                    const selectedOption = inventorySelect.options[inventorySelect.selectedIndex];
                    
                    if (selectedOption && selectedOption.value) {
                        inventoryRecordId = selectedOption.value;
                        
                        try {
                            const recordData = JSON.parse(selectedOption.dataset.record);
                            materialSKU = recordData['Material SKU'] || selectedOption.textContent;
                        } catch (e) {
                            materialSKU = selectedOption.textContent;
                        }
                        
                        const linkedMaterial = product.dataset.linkedMaterial;
                        if (linkedMaterial) {
                            try {
                                materialId = JSON.parse(linkedMaterial)[0];
                            } catch (e) {
                                console.warn('Could not parse linked material:', e);
                            }
                        }
                    }
                } else {
                    const materialSelect = product.querySelector('[data-field="material"]');
                    materialId = materialSelect.value;
                }
                
                const weight = parseFloat(product.querySelector('[data-field="weight"]').value);
                const buyPrice = parseFloat(product.querySelector('[data-field="buyPrice"]').value);
                const sellPrice = parseFloat(product.querySelector('[data-field="sellPrice"]')?.value || 0);
                const freightCost = parseFloat(product.querySelector('[data-field="freightCost"]')?.value || 0);
                const oceanFreight = parseFloat(product.querySelector('[data-field="oceanFreight"]')?.value || 0);
                const deposit = parseFloat(product.querySelector('[data-field="deposit"]')?.value || 0);
                const tariff = parseFloat(product.querySelector('[data-field="tariff"]')?.value || 0);
                const importCost = parseFloat(product.querySelector('[data-field="importCost"]')?.value || 0);
                const otherExpense1 = product.querySelector('[data-field="otherExpense1"]')?.value;
                const otherExpense1Cost = parseFloat(product.querySelector('[data-field="otherExpense1Cost"]')?.value || 0);
                const otherExpense2 = product.querySelector('[data-field="otherExpense2"]')?.value;
                const otherExpense2Cost = parseFloat(product.querySelector('[data-field="otherExpense2Cost"]')?.value || 0);
                const logisticsCompanyId = product.querySelector('[data-field="logisticsCompany"]')?.value;
                const buyRepId = product.querySelector('[data-field="buyRep"]')?.value;
                const sellRepId = product.querySelector('[data-field="sellRep"]')?.value;
                
                const schdPickUpDate = product.querySelector('[data-field="schdPickUpDate"]')?.value;
                const containerNo = product.querySelector('[data-field="containerNo"]')?.value;
                const bookingNo = product.querySelector('[data-field="bookingNo"]')?.value;
                const releaseNo = product.querySelector('[data-field="releaseNo"]')?.value;
                const loadingPort = product.querySelector('[data-field="loadingPort"]')?.value;
                
                const record = {
                    fields: {
                        'WKS No': generateWorksheetNumber(),
                        'SO Number': soNumber,
                        'Weight': weight,
                        'Buy Price (per LB)': buyPrice,
                        'Direct From Supplier': directFromSupplier,
                        'Domestic or International': 'International'
                    }
                };
                
                // Customer info
                const customerSelect = document.getElementById('customer');
                const customerId = customerSelect.value;
                const customerName = customerSelect.options[customerSelect.selectedIndex]?.dataset.name;

                if (customerId && customerId.startsWith('rec')) {
                    record.fields['Ship To'] = customerName;
                    record.fields['Ship To Company'] = [customerId];
                }
                
                // Supplier info (Buy From)
                if (!isInventory) {
                    // For regular products, get supplier from form
                    const supplierSelect = product.querySelector('[data-field="supplier"]');
                    const supplierId = supplierSelect?.value;
                    const supplierName = supplierSelect?.options[supplierSelect.selectedIndex]?.dataset.name;

                    if (supplierId && supplierId.startsWith('rec')) {
                        record.fields['Buy From'] = supplierName;
                        record.fields['Buy From (Linked)'] = [supplierId];
                    }
                    
                    // Add pickup address
                    const pickupStreet = product.querySelector('[data-field="pickupStreet"]')?.value;
                    if (pickupStreet) record.fields['Street No. (Pick Up)'] = pickupStreet;
                    
                    const pickupCity = product.querySelector('[data-field="pickupCity"]')?.value;
                    if (pickupCity) record.fields['City (Pick Up)'] = pickupCity;
                    
                    const pickupState = product.querySelector('[data-field="pickupState"]')?.value;
                    if (pickupState) record.fields['State (Pick Up)'] = pickupState;
                    
                    const pickupZip = product.querySelector('[data-field="pickupZip"]')?.value;
                    if (pickupZip) record.fields['Zip Code (Pick Up)'] = pickupZip;
                    
                    const pickupCountry = product.querySelector('[data-field="pickupCountry"]')?.value;
                    if (pickupCountry) record.fields['Country (Pick Up)'] = pickupCountry;

                } else {
                    // For inventory items, set Buy From to warehouse and populate pickup address
                    const warehouseName = product.dataset.warehouseName;
                    if (warehouseName) {
                        record.fields['Buy From'] = warehouseName;
                        
                        // Find the warehouse location record to get its address and supplier (Site Name)
                        const warehouseLocation = locationsData.find(function(loc) {
                            const locationName = loc.fields[primaryFields.location];
                            return locationName === warehouseName;
                        });
    


    if (warehouseLocation) {
        // Populate pickup address from warehouse location
        if (warehouseLocation.fields['Street Address']) {
            record.fields['Street No. (Pick Up)'] = warehouseLocation.fields['Street Address'];
        }
        if (warehouseLocation.fields['City']) {
            record.fields['City (Pick Up)'] = warehouseLocation.fields['City'];
        }
        if (warehouseLocation.fields['State']) {
            record.fields['State (Pick Up)'] = warehouseLocation.fields['State'];
        }
        if (warehouseLocation.fields['Zip Code']) {
            record.fields['Zip Code (Pick Up)'] = warehouseLocation.fields['Zip Code'];
        }
        record.fields['Country (Pick Up)'] = 'United States';
        
        // Get supplier from warehouse's "Site Name" field
        if (warehouseLocation.fields['Site Name']) {
            const siteNameData = warehouseLocation.fields['Site Name'];
            
            // Site Name is a linked record (array)
            if (Array.isArray(siteNameData) && siteNameData.length > 0) {
                const supplierId = siteNameData[0];
                
                // Link the supplier record ID
                record.fields['Buy From (Linked)'] = [supplierId];
                
                // Get the supplier name for the text field
                const supplier = companiesData.find(function(c) { return c.id === supplierId; });
                if (supplier) {
                    record.fields['Buy From'] = supplier.fields[primaryFields.company];
                    console.log('Using Site Name as supplier:', supplier.fields[primaryFields.company]);
                }
            }
        }
    }
}
const postDate = document.getElementById('postDate').value;
            if (postDate) record.fields['Post Date'] = postDate;
            
            const orderDate = document.getElementById('orderDate').value;
            if (orderDate) record.fields['Order Date'] = orderDate;
            
            const department = document.getElementById('department').value;
            if (department && department !== '' && department !== 'Select...') {
                record.fields['Dept'] = department;
            }
            
            const tradeType = document.getElementById('tradeType').value;
            if (tradeType && tradeType !== '' && tradeType !== 'Select...') {
                record.fields['Trade Type'] = tradeType;
            }
            
            // Always set Sales Status = SO Sent and Purchase Status = WORK for sales orders
            record.fields['Sales Status'] = 'SO Sent';
            record.fields['Purchase Status'] = 'WORK';
            
            const logistics = document.getElementById('logistics').value;
            if (logistics && logistics !== '' && logistics !== 'Select...') {
                record.fields['Logistics'] = logistics;
            }
            
            const paymentTerms = document.getElementById('paymentTerms').value;
            if (paymentTerms && paymentTerms !== '' && paymentTerms !== 'Select...') {
                record.fields['Payment Terms'] = paymentTerms;
            }

            const shippingTerms = document.getElementById('shippingTerms').value;
            if (shippingTerms && shippingTerms !== '' && shippingTerms !== 'Select...') {
                record.fields['Shipping Terms'] = shippingTerms;
            }

             if (materialId && materialId !== '') {
                if (materialId.startsWith('rec')) {
                    record.fields['Product'] = [materialId];
                }
            }
            
            if (materialSKU) {
                record.fields['Material SKU'] = materialSKU;
            }
            
            const shipToStreet = document.getElementById('shipToStreet').value;
            if (shipToStreet) record.fields['Street No. (Deliver)'] = shipToStreet;
            
            const shipToCity = document.getElementById('shipToCity').value;
            if (shipToCity) record.fields['City (Deliver)'] = shipToCity;
            
            const shipToState = document.getElementById('shipToState').value;
            if (shipToState) record.fields['State (Deliver)'] = shipToState;
            
            const shipToZip = document.getElementById('shipToZip').value;
            if (shipToZip) record.fields['Zip Code (Deliver)'] = shipToZip;
            
            const shipToCountry = document.getElementById('shipToCountry').value;
            if (shipToCountry) record.fields['Country (Deliver)'] = shipToCountry;
            
            if (schdPickUpDate) record.fields['Schd Pick Up Date'] = schdPickUpDate;
            if (containerNo) record.fields['Container #'] = containerNo;
            if (bookingNo) record.fields['Booking No'] = parseFloat(bookingNo);
            if (releaseNo) record.fields['Release No'] = parseFloat(releaseNo);
            if (loadingPort) record.fields['Loading Port'] = loadingPort;
            
            if (sellPrice > 0) {
                record.fields['Sell Price (per LB)'] = sellPrice;
            }
            
            if (freightCost > 0) {
                record.fields['Freight Cost'] = freightCost;
            }
            
            if (oceanFreight > 0) {
                record.fields['Ocean Freight'] = oceanFreight;
            }
            
            if (deposit > 0) {
                record.fields['Deposit'] = deposit;
            }
            
            if (tariff > 0) {
                record.fields['Tariff'] = tariff;
            }
            
            if (importCost > 0) {
                record.fields['Import Cost'] = importCost;
            }
            
            if (logisticsCompanyId && logisticsCompanyId !== '' && logisticsCompanyId !== 'Select...') {
                const logisticsSelect = product.querySelector('[data-field="logisticsCompany"]');
                const logisticsCompanyName = logisticsSelect.options[logisticsSelect.selectedIndex]?.dataset.name;
                
                if (logisticsCompanyName) {
                    record.fields['Carrier'] = logisticsCompanyName;
                }
                
                // Add linked carrier record
                if (logisticsCompanyId.startsWith('rec')) {
                    record.fields['Carrier (Linked)'] = [logisticsCompanyId];
                }
            }
            
            if (otherExpense1) {
                record.fields['Other (Expense)'] = otherExpense1;
            }
            
            if (otherExpense1Cost > 0) {
                record.fields['Other (Expense) $'] = otherExpense1Cost;
            }
            
            if (otherExpense2) {
                record.fields['Other (Expense) 2'] = otherExpense2;
            }
            
            if (otherExpense2Cost > 0) {
                record.fields['Other (Expense) $ 2'] = otherExpense2Cost;
            }
            
            if (buyRepId && buyRepId !== '') {
                if (buyRepId.startsWith('rec')) {
                    record.fields['Buy Rep'] = [buyRepId];
                }
            }
            
            if (sellRepId && sellRepId !== '') {
                if (sellRepId.startsWith('rec')) {
                    record.fields['Sell Rep'] = [sellRepId];
                }
            }
            
            console.log('Submitting record:', JSON.stringify(record, null, 2));
            
            const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE.baseId}/${AIRTABLE.tables.worksheets}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${AIRTABLE.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(record)
            });
            
            if (!response.ok) {
                const error = await response.json();
                console.error('Airtable error response:', error);
                throw new Error(error.error?.message || 'Failed to create worksheet');
            }
            
            const createdRecord = await response.json();
            createdWorksheetIds.push(createdRecord.id);
            console.log('Record created successfully:', createdRecord.id);
            
            // Update inventory if this was an inventory item
            if (inventoryRecordId) {
                try {
                    const availableWeight = parseFloat(product.dataset.availableWeight || 0);
                    const soldWeight = weight;
                    const remainingWeight = availableWeight - soldWeight;
                    
                    const inventoryUpdatePayload = {
                        fields: {}
                    };
                    
                    if (remainingWeight <= 0) {
                        inventoryUpdatePayload.fields['Status'] = 'Sold';
                        inventoryUpdatePayload.fields[primaryFields.inventoryWeight] = 0;
                    } else {
                        inventoryUpdatePayload.fields[primaryFields.inventoryWeight] = remainingWeight;
                    }
                    
                    console.log(`Updating inventory ${materialSKU}: ${availableWeight} - ${soldWeight} = ${remainingWeight}`);
                    
                    const inventoryUpdateResponse = await fetch(`https://api.airtable.com/v0/${AIRTABLE.baseId}/${AIRTABLE.tables.inventory}/${inventoryRecordId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(inventoryUpdatePayload)
                    });
                    
                    if (inventoryUpdateResponse.ok) {
                        console.log(`‚úÖ Inventory updated: ${materialSKU} - Remaining: ${remainingWeight} LBS`);
                    } else {
                        const error = await inventoryUpdateResponse.json();
                        console.warn(`Could not update inventory for ${materialSKU}:`, error);
                    }
                } catch (inventoryError) {
                    console.warn(`Error updating inventory:`, inventoryError);
                }
            }
        }
        
        showStatus('success', `‚úÖ Successfully created ${products.length} worksheet(s)!`);
        
        setTimeout(async function() {
            hideStatus();
            showSOModal();
            try {
                await generateAndUploadSO();
            } catch (error) {
                console.error('SO upload failed:', error);
            }
        }, 1000);
        
    } catch (error) {
        console.error('Error:', error);
        showStatus('error', `‚ùå Error: ${error.message}`);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Worksheets to Airtable';
    }
});
    </script>
